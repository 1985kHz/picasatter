/*
 * Copyright (c) 2012 Kota Tsuyuzaki 
*/
jQuery.fn.reverse = Array.prototype.reverse;
String.prototype.linkify = function(){
    return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&\?\/.=]+/g,function(m){
        return m.link(m);
      }
    );
};
String.prototype.linkuser = function(){
    return this.replace(/[@]+[A-Za-z0-9-_]+/g,function(u){
        var username = u.replace("@","")
        return u.link("http://twitter.com/"+username);
      }
    );
};
String.prototype.linktag = function(){
    return this.replace(/[#]+[A-Za-z0-9-_]+/,function(t){
        var tag = t.replace("#","%23")
        return t.link("http://search.twitter.com/search?q="+tag);
      }
    );
};

function make_url(elem){

    user = elem.attr('user');
    album = elem.attr('album');
    authkey = elem.attr('authkey')

    if(album != window.picasatter['text-'+album]){
        window.picasatter['last_id'+album] = 0;
        window.picasatter['text-'+album] = album;
        window.picasatter['count-'+album] = 12;;
    }
    if(window.picasatter['count-'+album] > 10){
        //elem.prepend('<div class="tweet"><img src="http://picasatter.com/widget/favicon.gif" align="absmiddle" />real time twitter by: <a href="http://picasatter.com" target="_blank">picasatter.com</a></div>');
        window.picasatter['count-'+album] = 0;
    }

    // Picasa Web Album API: https://picasaweb.google.com/data/feed/api/user/
    var url = "https://picasaweb.google.com/data/feed/api/user/"+user+"/albumid/"+album+'?';
    if(authkey){
        url += "alt=json&limit="+window.picasatter['count-'+album]+"&authkey="+authkey+"&callback=?";
    }else{
        url += "alt=json&limit="+window.picasatter['count-'+album]+"&callback=?";
    }
    return url; 
}

<<<<<<< HEAD
function fetch_main_window(src){
    $("#main_window").fadeOut(200, function(){
        $(this).attr("src",src);
        $(this).fadeIn(200);
      }
    );
}

=======
function slide_show(elem){

}
>>>>>>> add slideshow function and api 'f'

function fetch_photos(elem){
    
    // initialize div element
    elem = $(elem);
    if(window.picasatter['timer']==false){
        //alert("false");
        setTimeout(function(){fetch_photos(elem)},2000);
        return false;
    }

    var url = make_url(elem);
    $.getJSON(url,function(json){
        $('div.tweet:gt('+window.picasatter['limit']+')',elem).each(function(){$(this).fadeOut('slow')});
        $(json.feed.entry).each(function(){
            //feed.entry[{content:{src:hoge}}]
            if($('#tw'+this.gphoto$id.$t,elem).length==0){
                window.picasatter['cotunt-'+album]++;
                //var thedate=new Date(Date.parse(this.created_at));
	        var thedate = new Date();
	        var thedatestr = thedate.getHours()+':'+thedate.getMinutes();
                var src = this.content.src;
                //var thedatestr=thedate.getHours()+':'+thedate.getMinutes();
                var divstr = '<div id="tw'+this.gphoto$id.$t+'" class="waku"><img class="thumbnail" width="200" src="'+
                             src+'" ><br /><br /><br /></div>';
                             //this.content.src+'" ><p class="text">hogehoge<br />&nbsp;<b><a href="google.com"'+
                             //'target="_blank">user</a></b> &nbsp;-&nbsp;<b>'+thedatestr+'</b></p></div>';
                window.picasatter['last_id'+album] = this.gphoto$id.$t;
                elem.prepend(divstr);
                $('#tw'+this.gphoto$id.$t,elem).hide();
                $('#tw'+this.gphoto$id.$t,elem).bind("click", function(){fetch_main_window(src);});
                $('#tw'+this.gphoto$id.$t+' img',elem).hide();
                $('#tw'+this.gphoto$id.$t+' img',elem).fadeIn(2000);
                $('#tw'+this.gphoto$id.$t,elem).fadeIn('slow');
            }
          }
        );
        album = escape(album);
        rrp = 1;
        setTimeout(function(){fetch_photos(elem)},2000);
      }
    );
    return(false);
}


$(document).ready(function(){
    window.picasatter = {'timer':false};
    $('.picasatter').each(function(e){
        rrp = 6;
        elem = $(this);
        if(elem.attr('f')=='slideshow'){
            slide_show(this);
        }else{ 
            fetch_photos(this);
        }
      }
    );
  }
);
$(document).click(function(){
    if(window.picasatter['timer'])window.picasatter['timer'] = false;
    else window.picasatter['timer'] = true;
    $('#rend').toggle();
  }
);
